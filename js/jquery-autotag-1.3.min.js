!function(a){a.fn.autotag=function(){var c,b=a(this)[0],d=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},e=function(a,b){var c;if(null!==a){b=void 0===b?a.length:b,c=d();try{c.setStart(a,b),c.setEnd(a,b)}catch(a){}f(c)}return activeRange=d(),c},f=function(a){if(null!==a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return d()},g=function(a){return a=a&&a.replace(/ /g,"\u00a0")||"",document.createTextNode(a)},h=function(){var a=document.createElement("a"),b=document.createElement("br");return a.appendChild(b),a},i=function(a){var b=document.createElement("a");if(a){var c=g(a);b.appendChild(c)}return b},j=function(a){var b=document.createElement("p");return null!==a&&b.appendChild(a),b},k=function(a){for(;a.hasChildNodes();)a.removeChild(a.lastChild);return a},m=function(a){return document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1)},n=function(a,b){var c=!1;return void 0===b&&(b=a.firstChild.nodeValue),b.match(/^#[\w]+/)?(a.className="hash-autotag",c=!0):b.match(/^@[\w]+/)?(a.className="at-autotag",c=!0):a.removeAttribute("class"),c},o=function(a){a=void 0===a?t():a;var b=m(a),c=b.nextNode();if(null===c){k(a);var d=h();a.appendChild(d),e(d,0)}else{for(;c;)p(c).parentNode,c=b.nextNode();var g=a.querySelector("br:last-child");if(g){g.previousSibling.appendChild(g)}}return a},p=function(a){var b=a.parentNode;if(a.nodeType==Node.TEXT_NODE&&"P"===b.tagName){var c=i();b.insertBefore(c,a),c.appendChild(a),e(a)}return a},q=function(){if(null===m(b).nextNode()){k(b);var c=h(),d=j(c);b.appendChild(d),e(c,0)}},r=function(a){return(a=void 0===a?t():a)&&a.previousSibling},s=function(a){return(a=void 0===a?t():a)&&a.nextSibling},t=function(a){a=void 0===a?d():a;var b=null;if(a)for(b=a.endContainer;b.parentNode&&"P"!==b.tagName;)b=b.parentNode;return b},u=function(a){a=void 0===a?t():a;var b=null;if(a)for(b=1;null!==a.previousSibling;)b++,a=a.previousSibling;return b},w=function(a,b){if(a)if(void 0!==b){if(0===b){var c=a.querySelector("a:first-child");c&&e(c,0)}}else{var d=a.querySelector("a:last-child");d&&e(d)}return a},x=function(a){p(d().endContainer);var b=d(),c=b.endOffset,f=b.endContainer,g=a||f.nodeValue||"",h=g.split(/(\B[#@]\b\w+(?=\W*))/gi);h=h.filter(Boolean);var j=h.length;if(j>0){var k=f.parentNode;f.nodeValue=h[j-1],n(k);var l=g.length-h[j-1].length;if(c>l&&c<=g.length&&e(f,c-l),j>1)for(var m=k,o=m.parentNode,q=j-2;q>=0;q--)tagNode=i(h[q]),o.insertBefore(tagNode,m),n(tagNode),l-=h[q].length,c>l&&c<=l+h[q].length&&e(tagNode.firstChild,c-l),m=tagNode}};return b.addEventListener("keydown",function(a){c=u(),q()}),b.addEventListener("keyup",function(a){var b=a.keyCode?a.keyCode:a.which;if(x(),13==b)if(u()==c){var d=s();null!==d&&(o(d),w(d,0))}else{var e=t();o(r(e)),o(e),w(e)}}),b.addEventListener("paste",function(a){a.preventDefault();var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));var c=d().endContainer;if(c.nodeValue)c.nodeValue.concat(b);else{var f=document.createTextNode(b);c.insertBefore(f,c.firstChild),e(f,0)}x()}),b.addEventListener("click",function(a){q()}),b.addEventListener("focus",function(a){q()}),this}}(jQuery);
