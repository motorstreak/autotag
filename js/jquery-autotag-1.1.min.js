!function(a){a.fn.autotag=function(){var b=a(this)[0],c=function(a){return a.replace(/ /g,"\u00a0")},d=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},e=function(a,b){var c;return null!=a&&(c=d(),c.setStart(a,b),c.setEnd(a,b),f(c)),c},f=function(a){if(null!=a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select()},g=function(a){var b=document.createElement("a");return b.appendChild(document.createTextNode(c(a))),h(b,a),b},h=function(a,b){b.match(/^[\s]*#[\w]/)?a.className="hash-autotag":b.match(/^[\s]*@[\w]/)?a.className="at-autotag":a.removeAttribute("class")},i=function(a,b){b.parentNode.insertBefore(a,b.nextSibling)},j=function(a){var b=a&&a.parentNode;b&&b.removeChild(a)},k=function(a){var c=d(),k=(c.endOffset,c.endContainer),l=k.parentNode,m=k.nodeValue||"",n=m.match(/[,\.\s]*[^,\.\s]*/gi);if(null!=n){n=n.filter(Boolean);var p=n.length;if(console.log(n),p>0){if("A"!=l.tagName){var q=g(n[0]),r=q.firstChild;i(q,k),j(k),e(r,r.length),k=r,l=k.parentNode}h(l,k.nodeValue);var s=l.parentNode;if("DIV"!=s.tagName||s.isSameNode(b)){var t=l.nextSibling,u=o(l);s.insertBefore(u,t),e(k,k.length)}}if(p>1){k.nodeValue=n[0];for(var v=1;v<p;v++){var q=g(n[v]),r=q.firstChild;i(q,l),e(r,r.length),l=r.parentNode}}}},l=function(a){var b=d(),c=b.endOffset,f=b.endContainer,g=f.nodeValue;f.nodeValue=g.substring(0,c)+"\u00a0"+g.substring(c),e(f,c+1),k()},m=function(a){var b=d(),c=b.endContainer,e=b.endOffset,f=c.nodeValue,g=[f.substring(0,e),f.substring(e)];c.nodeValue=g[0]},n=function(){var a=document.createTreeWalker(b,NodeFilter.SHOW_TEXT,null,!1);return null==a.nextNode()},o=function(a){var b=document.createElement("div");return j(a),b.appendChild(a),b},p=function(){if(n())for(;b.firstChild;)b.removeChild(b.firstChild)};return b.addEventListener("focus",function(a){p()}),b.addEventListener("keydown",function(a){32==a.keyCode?(l(a),a.preventDefault()):13==a.keyCode&&(m(a),a.preventDefault())}),b.addEventListener("keyup",function(a){if(32!=a.keyCode&&13!=a.keyCode){var b=d().endContainer.nextSibling;b&&"BR"==b.tagName&&j(b),a.keyCode>40&&a.keyCode<112&&k(a)}}),this}}(jQuery);
