var Autotag=Autotag||{};Autotag=function(){return function(e,t){function n(e,t){t=void 0===t?"":t,f&&console.log("TRACE : "+t+" : "+e)}function r(e,t,n){var r;return function(){var o=this,a=arguments,i=function(){r=null,n||e.apply(o,a)},u=n&&!r;clearTimeout(r),r=setTimeout(i,t),u&&e.apply(o,a)}}var o,a,i,u,l,s,c={66:"font-weight:bold",73:"font-style:italic",85:"text-decoration:underline"},d=(t=t||{}).ignoreReturnKey||!1,f=t.trace||!1,g=t.decorator||function(e,t){},v=t.onReturnKey||function(){},p=t.splitter||function(e){return e.match(/([^,\s\.]+)|[,\s\.]+/gi)},h=t.afterClick||function(){},m=t.afterKeypress||function(){},C=t.afterPaste||function(){},y=t.afterSelection||function(e){},b=t.beforeClick||function(){return!0},N=t.beforeKeypress||function(){return!0},S=t.beforePaste||function(){return!0},j=function(e){return e.appendChild(B())},w=function(e,t){for(var n=0;n<t.length;n++)"clear"==t[n]&&(l=null,e.setAttribute("style",""))},E=function(e,t,n){for(var r=0;r<e.length;r++)"autotagjsCommand"==t?w(e[r],n):x(e[r],t,n)},x=function(e,t,n){for(var r=0;r<n.length;r++){var o=n[r].split(/\s*:\s*/),a=o[0],i=o[1],u=e.style.getPropertyValue(a);if("autotagjsUnset"==t||"autotagjsToggle"==t&&u.length>0)e.style.removeProperty(a);else if("autotagjsSet"==t||("autotagjsInitialize"==t||"autotagjsToggle"==t)&&0===u.length)e.style.setProperty(a,i);else if(t.match(/^autotagjs(Increment|Decrement)/)){u=u||getComputedStyle(e).getPropertyValue(a);var l=M(i),s=M(u);"autotagjsIncrement"==t?s+=l:"autotagjsDecrement"==t&&(s-=l),s<=0?e.style.removeProperty(a):e.style.setProperty(a,s+"px")}}},A=function(){return document.createElement("p")},B=function(){var e=document.createElement("autotag");return e.appendChild(document.createElement("br")),l&&e.setAttribute("style",l),e},D=function(e){var t=e.getElementsByClassName("autotagjs-submenu")[0];if(t)t.style.display="";else{(t=document.createElement("div")).className="autotagjs-submenu autotagjs-palette",e.appendChild(t);for(var n,r=Math.round(36),a=Math.round(8),i=Math.round(16),u=0,l=100,s=94;u<5;u++,l-=a,s-=i){n=L(t);for(var c=0,d=0;c<10;c++,d+=r)P(n,d,l,s)}for(n=L(t),i=Math.round(10),u=0,s=10;u<10;u++,s+=i)P(n,0,0,s)}o=t},P=function(e,t,n,r){var o=document.createElement("div"),a="hsla("+t+", "+n+"%, "+r+"%, 1.0)";o.className="autotagjs-palette-cell",o.style.color=o.style.background=a,e.appendChild(o)},L=function(e){var t=document.createElement("div");return t.className="autotagjs-palette-row",e.appendChild(t)},k=function(){var t=A();return e.appendChild(t),De(j(t),0),t},T=function(e){var t=document.createElement("autotag");return e&&t.appendChild(R(e)),t},R=function(e){return e=e&&e.replace(/ /g,"u00a0")||"",document.createTextNode(e)},V=function(){var e=Q(),t=e.endContainer;if(t==e.startContainer)if(oe(t))De(t,0);else if(ge(t))De(t.lastChild,0);else if(se(t)){var n=t.querySelectorAll("autotag");if(n.length>0){var r=n[e.endOffset-1]||n[n.length-1];De(r.lastChild)}}},O=function(t){if((t=void 0!==t)||!z())je(e),k();else for(var n=e.childNodes,r=0;r<n.length;r++)"P"!==n[r].tagName&&xe(n[r])},q=function(e){return e=void 0===e?F():e,se(e)&&(0===e.textContent.length?(je(e),De(j(e),0)):Ee(e)),e},I=function(e,t){if(t=void 0===t?0:t,e=void 0===e?Q().endContainer:e,ve(e)){var n=e.parentNode;if(se(n)){var r=T();n.insertBefore(r,e),r.appendChild(e),De(e,t)}else ge(n)&&we(n)}return e},K=function(e){if(u&&e){var t;switch(e.autotagjsScope){case"line":t=_(u);break;case"selection":var n=ee(u),r=_(u);t=r.length>1||n.length==te().length?n.concat(r):n;break;default:t=ee(u)}t=t.filter(Boolean);for(var o in e)e.hasOwnProperty(o)&&E(t,o,e[o].split(/\s*;\s*/));Be(u)}},M=function(e){return parseInt(e&&e.match(/^[-]*[0-9]+/)[0]||0)},z=function(){return e.querySelector("p:first-child")},U=function(e){return e.which||e.keyCode||0},F=function(e){for(e=void 0===e?Q()&&Q().endContainer:e;e&&!ue(e)&&!se(e);)e=e.parentNode;return se(e)?e:z()},X=function(e){e=void 0===e?F():e;var t;if(se(e))for(t=1;e=e.previousSibling;)t++;return t},_=function(e){for(var t=F(e.startContainer),n=F(e.endContainer),r=[t];t&&t!==n;)r.push(t=t.nextSibling);return r},G=function(e){return e=void 0===e?F():e,se(e)&&e.nextSibling},H=function(e){var t;return e&&!ue(e)&&(se(e)?t=e.firstChild:(ge(e)||de(e))&&(t=e.nextSibling||H(e.parentNode.nextSibling)),t||(t=H(e.parentNode.nextSibling)),oe(t)&&(t=H(t.parentNode.nextSibling))),t},J=function(e){return e=void 0===e?F():e,se(e)&&e.previousSibling},Q=function(){var e,t;return void 0!==window.getSelection?(e=window.getSelection()).rangeCount>0&&(t=e.getRangeAt(0)):(e=document.selection)&&"Control"!=e.type&&(t=e.createRange()),t},W=function(e,t){return e&&t&&window.getComputedStyle(e,null).getPropertyValue(t)},Y=function(e,t){return t=void 0===t||t<0?0:t,e.querySelector("a:nth-child("+t+")")},Z=function(e){var t=e.startContainer;return se(t)&&Y(t,e.startOffset+1)||ge(t)&&t||ve(t)&&t.parentNode},$=function(e){var t=e.endContainer;return se(t)&&Y(t,e.endOffset)||ge(t)&&t||ve(t)&&t.parentNode},ee=function(e){for(var t=Z(e),n=$(e),r=t&&[t]||[];t&&t!==n;)r.push(t=H(t));return r},te=function(e){return e=void 0===e?F():e,se(e)&&e.getElementsByTagName("autotag")},ne=function(e,t){if(t=void 0===t?0:t,se(e))if(0===t)De(e.querySelector("a:first-child"),0);else{var n=e.querySelectorAll("autotag");t=n.length>t?t:n.length-1,De(n[t])}return e},re=function(e){return e&&"BR"==e.tagName},oe=function(e){return ge(e)&&re(e.lastChild)},ae=function(e){return e.startContainer==e.endContainer&&e.startOffset==e.endOffset},ie=function(e){return 8==e},ue=function(t){return t&&t.isSameNode(e)},le=function(e){return 66==e||73==e||85==e},se=function(e){return e&&"P"==e.tagName},ce=function(e){return 13==e},de=function(e){return e&&"DIV"==e.tagName},fe=function(e){return 9==e},ge=function(e){return e&&e.tagName=="autotag".toUpperCase()},ve=function(e){return e&&e.nodeType==Node.TEXT_NODE},pe=function(t,n){if(t=void 0===t?e:t,(n=void 0!==n)&&Ae(t.querySelectorAll("div")),se(t))for(var r=t.querySelectorAll("autotag"),o=0;o<r.length;o++)ke(r[o])},he=function(){o&&(o.style.display="none")},me=function(){if(o){var e=window.getComputedStyle(o);o.style.display="none"===e.display?"":"none"}},Ce=function(e){he(),e.dataset.autotagjsPalette?D(e):e.dataset.autotagjsSelect?(o=e.getElementsByClassName("autotagjs-submenu")[0],me()):(K(e.dataset),pe(F(),!0))},ye=function(){var e=Q(),t=e.endContainer;if(ve(t)){var r=e.endOffset;I(t,r);var o=t.parentNode,a=p(t.nodeValue||""),i=(a=a&&a.filter(Boolean)||"").length;if(n(a,"splitter"),i>1){o.style.display="none";for(var u,l,s=0;s<i;s++)(u=T(a[s])).setAttribute("style",o.getAttribute("style")),u.style.display="inline",g(u,u.firstChild.nodeValue),o.parentNode.insertBefore(u,o.nextSibling),l=a[s].length,r>0&&r<=l&&De(u.firstChild,r),r-=l,o=u;xe(t.parentNode)}else g(o,o.firstChild.nodeValue)}else ge(t)&&ve(t.firstChild)&&g(t,t.firstChild.nodeValue)},be=function(e){var t;e.clipboardData?t=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(t=window.clipboardData.getData("Text"));var n=Q().endContainer;if(ue(n)&&(O(!0),n=Q().endContainer),ve(n))n.nodeValue=n.nodeValue+t,De(n);else{var r=document.createTextNode(t);n.insertBefore(r,n.firstChild),De(r)}ye()},Ne=function(){if(!1===d){var e=F();if(X(e)==a){var t=G(e);null!==t&&(q(t),ne(t,0))}else{var n=J(e);q(n),q(e),ne(e,0)}O(),ye(),V()}},Se=function(e){var t=Q(),n=t.endContainer.parentNode;ae(t)&&ge(n)&&(Te(n,t.endOffset),pe(F(),!0))},je=function(e){for(;e&&e.hasChildNodes();)e.removeChild(e.lastChild);return e},we=function(e){return Ae(e&&e.querySelectorAll("br"))},Ee=function(e){return e=void 0===e?F():e,se(e)&&we(e)},xe=function(e){return e&&e.parentNode&&e.parentNode.removeChild(e)},Ae=function(e){for(var t=0;e&&t<=e.length;t++)xe(e[t]);return e},Be=function(e){if(e)if(window.getSelection){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges(),t.addRange(e)}else document.createRange?window.getSelection().addRange(e):document.selection&&e.select();return e},De=function(e,t){return t=void 0===t?e.length:t,Le(e,t,e,t)},Pe=function(){var e=Q().endContainer,t=ge(e)&&e||ve(e)&&e.parentNode;l=t&&t.getAttribute("style")||l},Le=function(e,t,n,r){var o;if(e&&n){t=void 0===t?0:t,r=void 0===r?n.length:r,o=document.createRange();try{o.setStart(e,t),o.setEnd(n,r),u=o}catch(e){}Be(o)}return o},ke=function(e){if(e){var t=parseFloat(W(e,"font-size"));e.getBoundingClientRect().height>1.3*t&&(e.previousSibling&&"DIV"===e.previousSibling.tagName||e.parentNode.insertBefore(document.createElement("div"),e))}return e},Te=function(e,t){var n=e.textContent,r=e.parentNode,o=e.nextSibling,a=T("    ");if(0===t)r.insertBefore(a,e),De(e.firstChild,0);else if(t===e.firstChild.length)o&&(r.insertBefore(a,o),De(o.firstChild,0));else{e.textContent=n.substring(0,t),r.insertBefore(a,o);var i=T(n.substring(t));r.insertBefore(i,a.nextSibling),De(i.firstChild,0)}};return document.addEventListener("selectionchange",r(function(e){u=Q(),y(ee(u))},500)),e.addEventListener("dblclick",function(e){u=Q()}),e.addEventListener("click",function(e){he(),u=Q(),b()&&(O(),h())}),e.addEventListener("focus",function(e){u=Q(),O()}),e.addEventListener("textInput",function(e){!0===i&&(q(),ye(),pe(F(),!0))}),e.addEventListener("keydown",function(e){if(!0===(i=N(e))){a=X();var t=U(e);ie(t)?V():ce(t)?d?(e.preventDefault(),v()):Pe():fe(t)?(Se(),e.preventDefault()):e.metaKey&&le(t)&&(e.preventDefault(),K({autotagjsToggle:c[t]}))}}),e.addEventListener("keyup",function(e){if(!0===i){var t=U(e);ie(t)?(ue(Q().endContainer)?O():q(),pe(F(),!0)):ce(t)&&Ne(),m()}}),e.addEventListener("paste",function(e){!0===S()&&(e.preventDefault(),be(e),C())}),window.addEventListener("resize",r(function(e){pe(F(),!0)},250)),O(),{attachMenubar:function(e){e&&(s=e).addEventListener("click",function(e){Be(u);var t=e.target;if(t.classList.contains("autotagjs-menu")||t.parentNode.classList.contains("autotagjs-submenu"))Ce(t);else if(t.parentNode.classList.contains("autotagjs-menu"))Ce(t.parentNode);else if(t.classList.contains("autotagjs-palette-cell")){var n,r=t.style.backgroundColor,a=o.parentNode.dataset;"color"==a.autotagjsPalette?n="color: "+r:"fill"==a.autotagjsPalette&&(n="background-color: "+r),a.autotagjsSet=n,K(a),he()}})}}}}();
