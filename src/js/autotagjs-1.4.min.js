/*
 autotagjs.js v1.4 https://github.com/motorstreak/autotag */
var Autotag=Autotag||{},Autotag=function(){return function(e,f){function M(a,b,d){var g;return function(){var c=this,l=arguments,v=d&&!g;clearTimeout(g);g=setTimeout(function(){g=null;d||a.apply(c,l)},b);v&&a.apply(c,l)}}var q,N,z,t,A,O,ba={66:"font-weight:bold",73:"font-style:italic",85:"text-decoration:underline"};f=f||{};var P=f.ignoreReturnKey||!1,ca=f.trace||!1,E=f.decorator||function(a,b){},da=f.onReturnKey||function(){},ea=f.splitter||function(a){return a.match(/([^,\s\.]+)|[,\s\.]+/ig)},fa=
f.afterClick||function(){},ga=f.afterKeypress||function(){},ha=f.afterPaste||function(){},ia=f.afterSelection||function(a){},ja=f.beforeClick||function(){return!0},ka=f.beforeKeypress||function(){return!0},la=f.beforePaste||function(){return!0},ma=f.onMenuClick||function(){},Q=function(){var a=document.createElement("autotag");a.appendChild(document.createElement("br"));A&&a.setAttribute("style",A);return a},R=function(a,b,d,g){var c=document.createElement("div");c.className="autotagjs-palette-cell";
c.style.color=c.style.background="hsla("+b+", "+d+"%, "+g+"%, 1.0)";a.appendChild(c)},S=function(a){var b=document.createElement("div");b.className="autotagjs-palette-row";return a.appendChild(b)},B=function(a){var b=document.createElement("autotag");a&&b.appendChild(na(a));return b},na=function(a){a=a&&a.replace(/ /g,"\u00a0")||"";return document.createTextNode(a)},U=function(){var a=h(),b=a.endContainer;b==a.startContainer&&(T(b)?k(b,0):m(b)?k(b.lastChild,0):n(b)&&(b=b.querySelectorAll("autotag"),
0<b.length&&k((b[a.endOffset-1]||b[b.length-1]).lastChild)))},w=function(a){if("undefined"===typeof a&&e.querySelector("p:first-child")){a=e.childNodes;for(var b=0;b<a.length;b++)"P"!==a[b].tagName&&F(a[b])}else V(e),a=document.createElement("p"),e.appendChild(a),k(a.appendChild(Q()),0)},x=function(a){a="undefined"===typeof a?p():a;if(n(a))if(0===a.textContent.length)V(a),k(a.appendChild(Q()),0);else{var b=a,b="undefined"===typeof b?p():b;n(b)&&G(b&&b.querySelectorAll("br"))}return a},J=function(a){if(t&&
a){switch(a.autotagjsScope){case "line":var b=W(t);break;case "selection":b=H(t);var d=W(t),g;if(!(g=1<d.length)){g=b.length;var c=void 0;c="undefined"===typeof c?p():c;c=n(c)&&c.getElementsByTagName("autotag");g=g==c.length}b=g?b.concat(d):b;break;default:b=H(t)}b=b.filter(Boolean);for(var l in a)if(a.hasOwnProperty(l))if(d=b,g=l,c=a[l].split(/\s*;\s*/),"autotagjsCallback"==g)ma(c,d);else for(var v=0;v<d.length;v++)if("autotagjsCommand"==g)for(var f=d[v],e=c,h=0;h<e.length;h++)"clear"==e[h]&&(A=
null,f.setAttribute("style",""));else for(var f=d[v],e=g,h=c,k=0;k<h.length;k++){var r=h[k].split(/\s*:\s*/),m=r[0],q=r[1],r=f.style.getPropertyValue(m);"autotagjsUnset"==e||"autotagjsToggle"==e&&0<r.length?f.style.removeProperty(m):"autotagjsSet"==e||("autotagjsInitialize"==e||"autotagjsToggle"==e)&&0===r.length?f.style.setProperty(m,q):e.match(/^autotagjs(Increment|Decrement)/)&&(r=r||getComputedStyle(f).getPropertyValue(m),q=parseInt(q&&q.match(/^[-]*[0-9]+/)[0]||0),r=parseInt(r&&r.match(/^[-]*[0-9]+/)[0]||
0),"autotagjsIncrement"==e?r+=q:"autotagjsDecrement"==e&&(r-=q),0>=r?f.style.removeProperty(m):f.style.setProperty(m,r+"px"))}I(t)}},p=function(a){for(a="undefined"===typeof a?h()&&h().endContainer:a;a&&!C(a)&&!n(a);)a=a.parentNode;return n(a)?a:e.querySelector("p:first-child")},X=function(a){a="undefined"===typeof a?p():a;var b;if(n(a))for(b=1;a=a.previousSibling;)b++;return b},W=function(a){var b=p(a.startContainer);a=p(a.endContainer);for(var d=[b];b&&b!==a;)d.push(b=b.nextSibling);return d},D=
function(a){if(a&&!C(a)){if(n(a))var b=a.firstChild;else if(m(a)||a&&"DIV"==a.tagName)b=a.nextSibling||D(a.parentNode.nextSibling);b||(b=D(a.parentNode.nextSibling));T(b)&&(b=D(b.parentNode.nextSibling))}return b},h=function(){var a;if("undefined"!=typeof window.getSelection){var b=window.getSelection();0<b.rangeCount&&(a=b.getRangeAt(0))}else(b=document.selection)&&"Control"!=b.type&&(a=b.createRange());return a},Y=function(a,b){return a.querySelector("a:nth-child("+("undefined"===typeof b||0>b?
0:b)+")")},H=function(a){var b=a.startContainer;b=n(b)&&Y(b,a.startOffset+1)||m(b)&&b||u(b)&&b.parentNode;var d=a.endContainer;a=n(d)&&Y(d,a.endOffset)||m(d)&&d||u(d)&&d.parentNode;for(d=b&&[b]||[];b&&b!==a;)d.push(b=D(b));return d},Z=function(a){n(a)&&k(a.querySelector("a:first-child"),0)},T=function(a){var b;if(b=m(a))b=(a=a.lastChild)&&"BR"==a.tagName;return b},C=function(a){return a&&a.isSameNode(e)},n=function(a){return a&&"P"==a.tagName},m=function(a){return a&&"AUTOTAG"==a.tagName},u=function(a){return a&&
a.nodeType==Node.TEXT_NODE},y=function(a,b){a="undefined"===typeof a?e:a;"undefined"!==typeof b&&G(a.querySelectorAll("div"));if(n(a))for(var d=a.querySelectorAll("autotag"),g=0;g<d.length;g++){var c=d[g];if(c){var l=parseFloat;var f=c&&"font-size"&&window.getComputedStyle(c,null).getPropertyValue("font-size");l=l(f);c.getBoundingClientRect().height>1.3*l&&(c.previousSibling&&"DIV"===c.previousSibling.tagName||c.parentNode.insertBefore(document.createElement("div"),c))}}},K=function(){q&&(q.style.display=
"none")},aa=function(a){K();if(a.dataset.autotagjsPalette){var b=a.getElementsByClassName("autotagjs-submenu")[0];if(b)b.style.display="";else{b=document.createElement("div");b.className="autotagjs-submenu autotagjs-palette";a.appendChild(b);for(var d=Math.round(36),g=Math.round(8),c=Math.round(16),l=0,e=100,f=94;5>l;l++,e-=g,f-=c){a=S(b);for(var h=0,k=0;10>h;h++,k+=d)R(a,k,e,f)}a=S(b);c=Math.round(10);l=0;for(f=10;10>l;l++,f+=c)R(a,0,0,f)}q=b}else if(a.dataset.autotagjsSelect){if(q=a.getElementsByClassName("autotagjs-submenu")[0])b=
window.getComputedStyle(q),q.style.display="none"===b.display?"":"none"}else J(a.dataset),y(p(),!0)},L=function(){var a=h(),b=a.endContainer;if(u(b)){var a=a.endOffset,d=b,g=a,g="undefined"===typeof g?0:g,d="undefined"===typeof d?h().endContainer:d;if(u(d)){var c=d.parentNode;if(n(c)){var f=B();c.insertBefore(f,d);f.appendChild(d);k(d,g)}else m(c)&&G(c&&c.querySelectorAll("br"))}var e=b.parentNode,d=(d=ea(b.nodeValue||""))&&d.filter(Boolean)||"",g=d.length;ca&&console.log("TRACE : splitter : "+d);
if(1<g){e.style.display="none";for(f=0;f<g;f++)c=B(d[f]),c.setAttribute("style",e.getAttribute("style")),c.style.display="inline",E(c,c.firstChild.nodeValue),e.parentNode.insertBefore(c,e.nextSibling),e=d[f].length,0<a&&a<=e&&k(c.firstChild,a),a-=e,e=c;F(b.parentNode)}else E(e,e.firstChild.nodeValue)}else m(b)&&u(b.firstChild)&&E(b,b.firstChild.nodeValue)},V=function(a){for(;a&&a.hasChildNodes();)a.removeChild(a.lastChild);return a},F=function(a){return a&&a.parentNode&&a.parentNode.removeChild(a)},
G=function(a){for(var b=0;a&&b<=a.length;b++)F(a[b]);return a},I=function(a){if(a)if(window.getSelection){var b=window.getSelection();0<b.rangeCount&&b.removeAllRanges();b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return a},k=function(a,b){var d=b="undefined"===typeof b?a.length:b,g=b;if(a&&a){d="undefined"===typeof d?0:d;g="undefined"===typeof g?a.length:g;var c=document.createRange();try{c.setStart(a,d),c.setEnd(a,g),t=c}catch(l){}I(c)}return c};
document.addEventListener("selectionchange",M(function(a){t=h();ia(H(t));console.log("selectionchange")},500));e.addEventListener("dblclick",function(a){t=h()});e.addEventListener("click",function(a){K();ja()&&(x(),w(),fa())});e.addEventListener("focus",function(a){t=h();w()});e.addEventListener("textinput",function(a){!0===z&&(x(),L(),y(p(),!0))});e.addEventListener("keydown",function(a){z=ka(a);if(!0===z){N=X();var b=a.which||a.keyCode||0;if(8==b)U();else if(13==b)P?(a.preventDefault(),da(),p().style.removeProperty("counter-reset")):
(a=h().endContainer,(a=m(a)&&a||u(a)&&a.parentNode)&&(A=a.getAttribute("style")));else if(9==b){if(a.preventDefault(),b=h(),a=b.endContainer.parentNode,b.startContainer==b.endContainer&&b.startOffset==b.endOffset&&m(a)){var d=b.endOffset,g=a.textContent,b=a.parentNode,c=a.nextSibling,e=B("    ");0===d?(b.insertBefore(e,a),k(a.firstChild,0)):d===a.firstChild.length?c&&(b.insertBefore(e,c),k(c.firstChild,0)):(a.textContent=g.substring(0,d),b.insertBefore(e,c),a=B(g.substring(d)),b.insertBefore(a,e.nextSibling),
k(a.firstChild,0));y(p(),!0)}}else!a.metaKey||66!=b&&73!=b&&85!=b||(a.preventDefault(),J({autotagjsToggle:ba[b]}))}});e.addEventListener("keyup",function(a){if(!0===z){a=a.which||a.keyCode||0;if(8==a)C(h().endContainer)?w():x(),y(p(),!0);else if(13==a&&!1===P){a=p();if(X(a)==N)a="undefined"===typeof a?p():a,a=n(a)&&a.nextSibling,null!==a&&(x(a),Z(a));else{var b=a;b="undefined"===typeof b?p():b;b=n(b)&&b.previousSibling;x(b);x(a);Z(a)}a.style.removeProperty("counter-reset");w();L();U()}ga()}});e.addEventListener("paste",
function(a){if(!0===la()){a.preventDefault();var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));a=h().endContainer;C(a)&&(w(!0),a=h().endContainer);u(a)?(a.nodeValue+=b,k(a)):(b=document.createTextNode(b),a.insertBefore(b,a.firstChild),k(b));L();ha()}});window.addEventListener("resize",M(function(a){y(p(),!0)},250));w();return{attachMenubar:function(a){a&&(O=a,O.addEventListener("click",function(a){I(t);a=
a.target;if(a.classList.contains("autotagjs-menu")||a.parentNode.classList.contains("autotagjs-submenu"))aa(a);else if(a.parentNode.classList.contains("autotagjs-menu"))aa(a.parentNode);else if(a.classList.contains("autotagjs-palette-cell")){a=a.style.backgroundColor;var b=q.parentNode.dataset,e;"color"==b.autotagjsPalette?e="color: "+a:"fill"==b.autotagjsPalette&&(e="background-color: "+a);b.autotagjsSet=e;J(b);K()}}))}}}}();
