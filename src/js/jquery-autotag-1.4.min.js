!function(e){e.fn.autotag=function(n){function t(e){return e.split(/(\B[^,;\.\w]\b\w+(?=\W*))/gi)}function r(e){var n=e.firstChild.nodeValue;return n.match(/^#[\w]+/)?e.className="autotag-hashtag":n.match(/^@[\w]+/)?e.className="autotag-attag":e.removeAttribute("class"),e}var a=e(this)[0];n=n||{};var i,o=n.trace||!1,d=n.splitter||t,l=n.decorator||r,u=function(){var e;return window.getSelection?e=window.getSelection().getRangeAt(0):document.selection&&(e=document.selection.createRange()),e},c=function(e,n){var t;if(null!==e){n="undefined"==typeof n?e.length:n,t=u();try{t.setStart(e,n),t.setEnd(e,n)}catch(r){}f(t)}return activeRange=u(),t},f=function(e){if(null!==e)if(window.getSelection){var n=window.getSelection();n.rangeCount>0&&n.removeAllRanges(),n.addRange(e)}else document.createRange?window.getSelection().addRange(e):document.selection&&e.select();return u()},s=function(e){return e=e&&e.replace(/ /g,"\u00a0")||"",document.createTextNode(e)},v=function(){var e=document.createElement("a"),n=document.createElement("br");return e.appendChild(n),e},p=function(e){var n=document.createElement("a");if(e){var t=s(e);n.appendChild(t)}return n},g=function(e){var n=document.createElement("p");return null!==e&&n.appendChild(e),n},h=function(e){for(;e.hasChildNodes();)e.removeChild(e.lastChild);return e},N=function(e){return document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1)},m=function(e){if(e="undefined"==typeof e?S():e,e.nodeType!==Node.DOCUMENT_NODE){var n=N(e),t=n.nextNode();if(null===t){h(e);var r=v();e.appendChild(r),c(r,0)}else{for(var a;t;)a=C(t).parentNode,t=n.nextNode();var i=e.querySelector("br:last-child");if(i){var o=i.previousSibling;o.appendChild(i)}}}return e},C=function(e){var n=e.parentNode;if(e.nodeType==Node.TEXT_NODE&&"P"===n.tagName){var t=p();n.insertBefore(t,e),t.appendChild(e),c(e)}return e},w=function(){var e=N(a),n=e.nextNode();if(null===n){h(a);var t=v(),r=g(t);a.appendChild(r),c(t,0)}else m()},y=function(e){return e="undefined"==typeof e?S():e,e&&e.previousSibling},E=function(e){return e="undefined"==typeof e?S():e,e&&e.nextSibling},S=function(e){e="undefined"==typeof e?u():e;var n=null;if(e)for(n=e.endContainer;n.parentNode&&"P"!==n.tagName;)n=n.parentNode;return n},b=function(e){e="undefined"==typeof e?S():e;var n=null;if(e)for(n=1;null!==e.previousSibling;)n++,e=e.previousSibling;return n},T=function(e,n){if(e)if("undefined"!=typeof n){if(0===n){var t=e.querySelector("a:first-child");t&&c(t,0)}}else{var r=e.querySelector("a:last-child");r&&c(r)}return e},D=function(e){C(u().endContainer);var n=u(),t=n.endOffset,r=n.endContainer,a=e||r.nodeValue||"",i=d(a);i=i&&i.filter(Boolean)||"";var f=i.length;if(o&&console.log(i),f>0){var s=r.parentNode;r.nodeValue=i[f-1],l(s);var v=a.length-i[f-1].length;if(t>v&&t<=a.length&&c(r,t-v),f>1)for(var g=s,h=g.parentNode,N=f-2;N>=0;N--)tagNode=p(i[N]),h.insertBefore(tagNode,g),l(tagNode),v-=i[N].length,t>v&&t<=v+i[N].length&&c(tagNode.firstChild,t-v),g=tagNode}};return a.addEventListener("keydown",function(e){i=b()}),a.addEventListener("keyup",function(e){D();var n=e.keyCode?e.keyCode:e.which;if(13==n)if(b()==i){var t=E();null!==t&&(m(t),T(t,0))}else{var r=S();m(y(r)),m(r),T(r)}}),a.addEventListener("paste",function(e){e.preventDefault();var n;e.clipboardData?n=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(n=window.clipboardData.getData("Text"));var t=u().endContainer;if(t.nodeValue)t.nodeValue.concat(n);else{var r=document.createTextNode(n);t.insertBefore(r,t.firstChild),c(r,0)}D()}),a.addEventListener("click",function(e){w()}),a.addEventListener("focus",function(e){w()}),this}}(jQuery);
