!function(e){e.fn.autotag=function(n){function t(e,n){n=void 0===n?"":n,d&&console.log("TRACE : "+n+" : "+e)}var r,i,o,a=e(this)[0],u={66:"autotag-bold",73:"autotag-italic",85:"autotag-underline"},l=(n=n||{}).ignoreReturnKey||!1,d=n.trace||!1,f=n.decorator||function(e,n){},c=n.onReturnKey||function(){},s=n.splitter||function(e){return e.match(/([^\s]+)|\s+/gi)},v=n.afterClick||function(){},g=n.afterKeypress||function(){},p=n.afterPaste||function(){},h=n.beforeClick||function(){return!0},C=n.beforeKeypress||function(){return!0},m=n.beforePaste||function(){return!0},S=function(e){var n=N();return e.appendChild(n),n},y=function(){return document.createElement("p")},N=function(){var e=document.createElement("a");return e.appendChild(document.createElement("br")),e},b=function(){var e=y();return a.appendChild(e),ce(S(e),0),e},w=function(e){var n=document.createElement("a");return e&&n.appendChild(E(e)),n},E=function(e){return e=e&&e.replace(/ /g,"\u00a0")||"",document.createTextNode(e)},x=function(){var e=K(),n=e.endContainer;if(G(n))ce(n,0);else if($(n))ce(n.lastChild);else if(W(n)){var t=n.querySelectorAll("a");if(t.length>0){var r=t[e.endOffset-1]||t[t.length-1];ce(r.lastChild)}}},R=function(e){if((e=void 0!==e)||!k())oe(a),b();else for(var n=a.childNodes,t=0;t<n.length;t++)"P"!==n[t].tagName&&le(n[t])},D=function(e){return e=void 0===e?O():e,W(e)&&(0===e.textContent.length?(oe(e),ce(S(e),0)):ue(e)),e},A=function(e,n){if(n=void 0===n?0:n,e=void 0===e?K().endContainer:e,ee(e)){var t=e.parentNode;if(W(t)){var r=w();t.insertBefore(r,e),r.appendChild(e),ce(e,n)}else $(t)&&ae(t)}return e},V=function(e,n,t){n=void 0===n?K():n,t=void 0===t?"text":t;var r=u[e]||"autotag-"+e;r&&("editor"==t?T(r):"line"==t?q(r,z(n)):B(r,U(n)))},q=function(e,n){for(var t,r=0;r<n.length;r++)(t=n[r])&&t.setAttribute("class",e)},B=function(e,n){for(var t,r=0;r<n.length;r++)(t=n[r])&&!t.textContent.match(/\s+/g)&&t.classList.toggle(e)},T=function(e){},k=function(){return a.querySelector("p:first-child")},K=function(){var e,n;return void 0!==window.getSelection?(n=window.getSelection()).rangeCount>0&&(e=n.getRangeAt(0)):(n=document.selection)&&"Control"!=n.type&&(e=n.createRange()),e},L=function(e,n){return e&&n&&window.getComputedStyle(e,null).getPropertyValue(n)},P=function(e){var n=e.which||e.keyCode||0;return t(n,"Key"),n},O=function(e){for(e=void 0===e?K().endContainer:e;e&&!J(e)&&!W(e);)e=e.parentNode;return W(e)?e:k()},j=function(e){e=void 0===e?O():e;var n;if(W(e))for(n=1;e=e.previousSibling;)n++;return n},z=function(e){for(var n=O(e.startContainer),t=O(e.endContainer),r=[n];n&&n!==t;)r.push(n=n.nextSibling);return r},F=function(e){return e=void 0===e?O():e,W(e)&&e.nextSibling},I=function(e){var n;return e&&!J(e)&&(W(e)?n=e.firstChild:$(e)&&(n=e.nextSibling||I(e.parentNode.nextSibling)),n||(n=I(e.parentNode.nextSibling)),G(n)&&(n=I(n.parentNode.nextSibling))),n},Q=function(e){return e=void 0===e?O():e,W(e)&&e.previousSibling},U=function(e){for(var n=e.startContainer,t=e.endContainer,r=$(n)&&n||ee(n)&&n.parentNode,i=$(t)&&t||ee(t)&&t.parentNode,o=[r];r&&r!==i;)o.push(r=I(r));return o},X=function(e,n){if(n=void 0===n?0:n,W(e))if(0===n){var t=e.querySelector("a:first-child");ce(t,0)}else{var r=e.querySelectorAll("a");n=r.length>n?n:r.length-1,ce(r[n])}return e},_=function(e){return e&&"BR"==e.tagName},G=function(e){return $(e)&&_(e.lastChild)},H=function(e){return 8==e},J=function(e){return e&&e.isSameNode(a)},M=function(e){return 66==e||73==e||85==e},W=function(e){return e&&"P"==e.tagName},Y=function(e){return 32==e||e>47&&e<58||e>64&&e<91||e>95&&e<112||e>185&&e<193||e>218&&e<223},Z=function(e){return 13==e},$=function(e){return e&&e.tagName=="a".toUpperCase()},ee=function(e){return e&&e.nodeType==Node.TEXT_NODE},ne=function(e,n){if(e=void 0===e?a:e,(n=void 0!==n)&&de(e.querySelectorAll("div")),W(e))for(var t=e.querySelectorAll("a"),r=0;r<t.length;r++)se(t[r])},te=function(){var e=K(),n=e.endContainer;if(ee(n)){var r=e.endOffset;A(n,r);var i=s(n.nodeValue||""),o=(i=i&&i.filter(Boolean)||"").length;t(i,"splitter");var a=n.parentNode;if(o>1){a.style.display="none";for(var u,l,d=0;d<o;d++)u=w(i[d]),f(u,u.firstChild.nodeValue),a.parentNode.insertBefore(u,a.nextSibling),l=i[d].length,r>0&&r<=l&&ce(u.firstChild,r),r-=l,a=u;le(n.parentNode)}else f(a,a.firstChild.nodeValue)}else $(n)&&ee(n.firstChild)&&f(n,n.firstChild.nodeValue)},re=function(e){var n;e.clipboardData?n=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(n=window.clipboardData.getData("Text"));var t=K().endContainer;if(J(t)&&(R(!0),t=K().endContainer),ee(t))t.nodeValue=t.nodeValue+n,ce(t);else{var r=document.createTextNode(n);t.insertBefore(r,t.firstChild),ce(r)}te()},ie=function(){if(!1===l){var e=O();if(j(e)==r){var n=F(e);null!==n&&(D(n),X(n,0))}else{var t=Q(e);D(t),D(e),X(e,0)}R(),te()}},oe=function(e){for(;e&&e.hasChildNodes();)e.removeChild(e.lastChild);return e},ae=function(e){return de(e&&e.querySelectorAll("br"))},ue=function(e){return e=void 0===e?O():e,W(e)&&ae(e)},le=function(e){return e&&e.parentNode&&e.parentNode.removeChild(e)},de=function(e){for(var n=0;e&&n<=e.length;n++)le(e[n]);return e},fe=function(e){if(e)if(window.getSelection){var n=window.getSelection();n.rangeCount>0&&n.removeAllRanges(),n.addRange(e)}else document.createRange?window.getSelection().addRange(e):document.selection&&e.select();return e},ce=function(e,n){var t;if(null!==e){n=void 0===n?e.length:n,t=document.createRange();try{t.setStart(e,n),t.setEnd(e,n)}catch(e){}fe(t)}return t},se=function(e){if(e){var n=parseFloat(L(e,"font-size"));if(e.getBoundingClientRect().height>1.3*n&&!(e.previousSibling&&"DIV"===e.previousSibling.tagName)){var t=document.createElement("div");e.parentNode.insertBefore(t,e)}}return e};return a.addEventListener("click",function(e){h()&&(R(),x(),o=K(),v())}),a.addEventListener("focus",function(e){R()}),a.addEventListener("keydown",function(e){if(!0===(i=C(e))){r=j();var n=P(e);H(n)?x():Z(n)&&l?(e.preventDefault(),c()):e.metaKey&&M(n)&&(e.preventDefault(),V(n))}}),a.addEventListener("keyup",function(e){if(!0===i){var n=P(e);H(n)?(J(K().endContainer)?R():D(),ne(O(),!0)):Z(n)?ie():Y(n)&&(D(),te(),ne(O(),!0)),g()}}),a.addEventListener("paste",function(e){!0===m()&&(e.preventDefault(),re(e),p())}),R(),{applyStyle:function(e,n){V(e,o,n)}}}}(jQuery);
