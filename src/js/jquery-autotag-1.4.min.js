!function(a){a.fn.autotag=function(b){function e(a,b){b=void 0===b?"":b,o&&console.log("TRACE "+a+" => "+b)}function f(a){return a.match(/([^\s]+)|\s+/gi)}function g(a,b){}function h(a){return!0}function i(){}function j(){return!0}function k(){}function l(){return!0}function m(){}function n(){}var c=a(this)[0],d="autotag-line";b=b||{};var z,A,o=b.trace||!1,p=b.ignoreReturnKey||!1,q=b.splitter||f,r=b.decorator||g,s=b.onReturnKey||n,t=b.beforeKeypress||h,u=b.afterKeypress||i,v=b.beforePaste||j,w=b.afterPaste||k,x=b.beforeClick||l,y=b.afterClick||m,B=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},C=function(a,b){var c;if(null!==a){b=void 0===b?a.length:b,c=B();try{c.setStart(a,b),c.setEnd(a,b)}catch(a){}D(c)}return activeRange=B(),c},D=function(a){if(a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return B()},E=function(a){return a=a&&a.replace(/ /g,"\u00a0")||"",document.createTextNode(a)},F=function(){var a=document.createElement("a"),b=document.createElement("br");return a.appendChild(b),a},G=function(a){var b=document.createElement("a");if(a){var c=E(a);b.appendChild(c)}return b},H=function(a){var b=document.createElement("p");return b.className=d,null!==a&&b.appendChild(a),b},I=function(){var a=F();return H(a)},J=function(a){for(;a&&a.hasChildNodes();)a.removeChild(a.lastChild);return a},L=function(a){return a&&document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1)},M=function(a,b){if(!1===p&&(a=a||W(),b=void 0===b?10:b,null!==a)){var c=B(),d=c.endContainer.parentNode,e=a.getBoundingClientRect().right;if(T(d)){var f=d.getBoundingClientRect().right;if(console.log(f+" : "+e),f+b>=e){var g=R(a)||I();a.parentNode.insertBefore(g,a.nextSibling),a.childNodes.length>2&&(g.insertBefore(d,g.firstChild),C(d.firstChild))}}}},N=function(a){if(a=void 0===a?W():a){var b=L(a),d=b&&b.nextNode();if(null===d){J(a);var e=F();a.appendChild(e),C(e,0)}else{for(;d;)O(d),d=b.nextNode();var f=a.querySelector("br:last-child");if(f&&S(f.parentNode)){var g=f.previousSibling;g&&T(g)&&g.appendChild(f)}}}else a=I(),c.appendChild(a);return a},O=function(a){if(V(a)){var b=a.parentNode;if(S(b)){var c=G();b.insertBefore(c,a),c.appendChild(a),C(a)}}return a},P=function(){if(null===L(c).nextNode()){J(c);var d=F(),e=H(d);c.appendChild(e),C(d,0)}else N()},Q=function(a){return(a=void 0===a?W():a)&&a.previousSibling},R=function(a){return(a=void 0===a?W():a)&&a.nextSibling},S=function(a){return a&&"P"==a.tagName&&a.className===d},T=function(a){return a&&"A"==a.tagName},U=function(a){return a&&a.isSameNode(c)},V=function(a){return a&&a.nodeType==Node.TEXT_NODE},W=function(a){a=void 0===a?B():a;var b=null;if(a){for(var c=a.endContainer;c&&!U(c)&&!S(c)&&(c=c.parentElement););if(null!==c)if(S(c))b=c;else{var e="p."+d+":first-child";b=c.querySelector(e)}}return b},X=function(a){a=void 0===a?W():a;var b=null;if(a)for(b=1;null!==a.previousSibling;)b++,a=a.previousSibling;return b},Z=function(a,b){if(a)if(void 0!==b){if(0===b){var c=a.querySelector("a:first-child");c&&C(c,0)}}else{var d=a.querySelector("a:last-child");d&&C(d)}return a},$=function(a){var b=a.which||a.keyCode||0;return 32==b||13==b||b>47&&b<58||b>64&&b<91||b>95&&b<112||b>185&&b<193||b>218&&b<223},aa=function(a){var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));var c=B().endContainer;if(V(c))c.nodeValue=c.nodeValue+b,C(c);else{var d=document.createTextNode(b);c.insertBefore(d,c.firstChild),C(d)}ba()},ba=function(a){N(),O(B().endContainer);var b=B(),c=b.endOffset,d=b.endContainer,f=a||d.nodeValue||"",g=q(f);g=g&&g.filter(Boolean)||"";var h=g.length;if(e("Splitter Output",g),h>0){var i=d.parentNode;d.nodeValue=g[h-1],r(i,i.firstChild.nodeValue);var j=f.length-g[h-1].length;if(c>j&&c<=f.length&&C(d,c-j),h>1)for(var k=i,l=k.parentNode,m=h-2;m>=0;m--)tagNode=G(g[m]),l.insertBefore(tagNode,k),r(tagNode,tagNode.firstChild.nodeValue),j-=g[m].length,c>j&&c<=j+g[m].length&&C(tagNode.firstChild,c-j),k=tagNode}};return c.addEventListener("keydown",function(a){if(!0===(z=t(a))){A=X();var b=a.which||a.keyCode||0;e("keydown",b),13==b?!0===p&&(a.preventDefault(),s()):$(a)&&M()}}),c.addEventListener("keyup",function(a){if(!0===z){var b=$(a);b&&ba();if(13==(a.which||a.keyCode||0)&&!1===p)if(X()==A){var d=R();null!==d&&(N(d),Z(d,0))}else if(b){var e=W();N(Q(e)),N(e),Z(e)}u()}}),c.addEventListener("paste",function(a){!0===v()&&(a.preventDefault(),aa(a),w())}),c.addEventListener("click",function(a){!0===x()&&(P(),y())}),this}}(jQuery);
