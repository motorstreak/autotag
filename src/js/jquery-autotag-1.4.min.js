!function(a){a.fn.autotag=function(b){function e(a,b){b=void 0===b?"":b,o&&console.log("TRACE : "+b+" : "+a)}function f(a){return a.match(/([^\s]+)|\s+/gi)}function g(a,b){}function h(a){return!0}function i(){}function j(){return!0}function k(){}function l(){return!0}function m(){}function n(){}var c=a(this)[0],d="autotag-line";b=b||{};var A,B,o=b.trace||!1,p=b.newlineOnWrap||!1,q=b.ignoreReturnKey||!1,r=b.splitter||f,s=b.decorator||g,t=b.onReturnKey||n,u=b.beforeKeypress||h,v=b.afterKeypress||i,w=b.beforePaste||j,x=b.afterPaste||k,y=b.beforeClick||l,z=b.afterClick||m,C=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},D=function(a,b){var c;if(null!==a){b=void 0===b?a.length:b,c=C();try{c.setStart(a,b),c.setEnd(a,b)}catch(a){}E(c)}return activeRange=C(),c},E=function(a){if(a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return C()},F=function(a){return a=a&&a.replace(/ /g,"\u00a0")||"",document.createTextNode(a)},G=function(a){var b=document.createElement("a");if(a){var c=F(a);b.appendChild(c)}return b},H=function(){return document.createElement("p")},I=function(a){var b=G("");return b.appendChild(document.createElement("br")),a.appendChild(b),b},J=function(){var a=H();c.appendChild(a);var b=I(a);return D(b,0),a},K=function(a){for(var c,b=0,d=a.querySelectorAll("BR");(c=d[b++])&&b<=d.length;){var e=c.parentNode;e.removeChild(c),0===e.childNodes.length&&M(e)}},L=function(a){for(;a&&a.hasChildNodes();)a.removeChild(a.lastChild);return a},M=function(a){return a&&a.parentNode&&a.parentNode.removeChild(a),a},N=function(a){return a&&document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1)},O=function(a,b){if(!1===q&&(a=a||$(),b=void 0===b?10:b,null!==a)){var c=C(),d=c.endContainer.parentNode,f=a.getBoundingClientRect().right;if(V(d)){var g=d.getBoundingClientRect().right;if(e(g+":"+f,"Line to text block right position"),g+b>=f){var h=T(a)||J();a.childNodes.length>2&&(h.insertBefore(d,h.firstChild),D(d.firstChild))}}}},P=function(a){if(a=void 0===a?$():a){var b=N(a),c=b&&b.nextNode();if(null===c){L(a);var d=I(a);D(d,0)}else{for(;c;)Q(c),c=b.nextNode();K(a),I(a)}}else a=J();return a},Q=function(a){if(X(a)){var b=a.parentNode;if(U(b)){var c=G();b.insertBefore(c,a),c.appendChild(a),D(a)}}return a},R=function(){null===N(c).nextNode()?(L(c),J()):P()},S=function(a){return(a=void 0===a?$():a)&&a.previousSibling},T=function(a){return(a=void 0===a?$():a)&&a.nextSibling},U=function(a){return a&&"P"==a.tagName},V=function(a){return a&&"A"==a.tagName},W=function(a){return a&&a.isSameNode(c)},X=function(a){return a&&a.nodeType==Node.TEXT_NODE},Y=function(a){return a&&"BR"==a.tagName},Z=function(a){var b=a.which||a.keyCode||0;return e(b,"Key"),b},$=function(a){a=void 0===a?C():a;var b=null;if(a){for(var c=a.endContainer;c&&!W(c)&&!U(c);)c=c.parentNode;if(c)if(U(c))b=c;else{var e="p."+d+":first-child";b=c.querySelector(e)}}return b},_=function(a){a=void 0===a?$():a;var b=null;if(a)for(b=1;null!==a.previousSibling;)b++,a=a.previousSibling;return b},ba=function(a,b){if(a)if(void 0!==b){if(0===b){var c=a.querySelector("a:first-child");c&&D(c,0)}}else{var d=a.querySelector("a:last-child");d&&D(d)}return a},ca=function(a){return 8==a},da=function(a){return 13==a},ea=function(a){return 32==a||a>47&&a<58||a>64&&a<91||a>95&&a<112||a>185&&a<193||a>218&&a<223},fa=function(){if(!1===q)if(_()==B){var a=T();null!==a&&(P(a),ba(a,0))}else{var b=$();P(S(b)),P(b),ba(b)}},ga=function(a){var b=a.previousSibling;if(b){if(U(b))return b.querySelector("a:nth-last-child(1)");if(V(b))return b}else if(V(a))return ga(a.parentNode)},ha=function(a,b){var c;if(X(a))if((b=void 0===b?a.nodeValue.length:b)>0){var d=a.nodeValue;a.nodeValue=d.slice(0,b-1)+d.slice(b),D(a,b-1),P()}else 0===b?(c=ga(a.parentNode),ha(c.firstChild),0===a.nodeValue.length&&M(a.parentNode)):D(a);else if(Y(a)){if(c=ga(a.parentNode)){ha(c.firstChild,-1);for(var e=T(),f=$();e.childNodes.length>0;)f.appendChild(e.childNodes[0]);M(a),M(e)}}else(c=ga(a))&&ha(c.firstChild)},ia=function(){var a=C();return a.startOffset===a.endOffset&&(ha(a.endContainer,a.endOffset),!0)},ja=function(a){var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));var c=C().endContainer;if(X(c))c.nodeValue=c.nodeValue+b,D(c);else{var d=document.createTextNode(b);c.insertBefore(d,c.firstChild),D(d)}ka()},ka=function(a){Q(C().endContainer);var b=C(),c=b.endOffset,d=b.endContainer,f=a||d.nodeValue||"",g=r(f);g=g&&g.filter(Boolean)||"";var h=g.length;if(e(g,"splitter"),h>0){var i=d.parentNode;d.nodeValue=g[h-1],s(i,i.firstChild.nodeValue);var j=f.length-g[h-1].length;if(c>j&&c<=f.length&&D(d,c-j),h>1)for(var k=i,l=k.parentNode,m=h-2;m>=0;m--)tagNode=G(g[m]),l.insertBefore(tagNode,k),s(tagNode,tagNode.firstChild.nodeValue),k=tagNode}};return c.addEventListener("keydown",function(a){if(!0===(A=u(a))){B=_();var b=Z(a);ca(b)?!0===ia()&&a.preventDefault():da(b)?!0===q&&(a.preventDefault(),t()):ea(b)&&!0===p&&O()}}),c.addEventListener("keyup",function(a){if(!0===A){var b=Z(a);ea(b)?(P(),ka()):console.log(C().endContainer),da(b)&&fa(),v()}}),c.addEventListener("paste",function(a){!0===w()&&(a.preventDefault(),ja(a),x())}),c.addEventListener("click",function(a){!0===y()&&(R(),z())}),this}}(jQuery);
