!function(a){a.fn.autotag=function(b){function e(a,b){b=void 0===b?"":b,o&&console.log("TRACE : "+b+" : "+a)}function f(a){return a.match(/([^\s]+)|\s+/gi)}function g(a,b){}function h(a){return!0}function i(){}function j(){return!0}function k(){}function l(){return!0}function m(){}function n(){}var c=a(this)[0],d="autotag-line";b=b||{};var z,A,o=b.trace||!1,p=b.ignoreReturnKey||!1,q=b.splitter||f,r=b.decorator||g,s=b.onReturnKey||n,t=b.beforeKeypress||h,u=b.afterKeypress||i,v=b.beforePaste||j,w=b.afterPaste||k,x=b.beforeClick||l,y=b.afterClick||m,B=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},C=function(a,b){var c;if(null!==a){b=void 0===b?a.length:b,c=B();try{c.setStart(a,b),c.setEnd(a,b)}catch(a){}D(c)}return activeRange=B(),c},D=function(a){if(a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return B()},E=function(a){return a=a&&a.replace(/ /g," ")||"",document.createTextNode(a)},F=function(a){var b=document.createElement("a");if(a){var c=E(a);b.appendChild(c)}return b},G=function(){return document.createElement("p")},H=function(a){var b=F();return b.appendChild(document.createElement("br")),a.appendChild(b),b},I=function(){var a=G();return c.appendChild(a),H(a),a},J=function(a){for(var c,b=0,d=a.querySelectorAll("BR");(c=d[b++])&&b<=d.length;){var e=c.parentNode;e.removeChild(c),0===e.childNodes.length&&L(e)}},K=function(a){for(;a&&a.hasChildNodes();)a.removeChild(a.lastChild);return a},L=function(a){return a&&a.parentNode&&a.parentNode.removeChild(a),a},M=function(a){return a&&document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1)},N=function(a,b){if(!1===p&&(a=a||Z(),b=void 0===b?10:b,null!==a)){var c=B(),d=c.endContainer.parentNode,f=a.getBoundingClientRect().right;if(U(d)){var g=d.getBoundingClientRect().right;if(e(g+":"+f,"Line to text block right position"),g+b>=f){var h=S(a)||I();a.childNodes.length>2&&(h.insertBefore(d,h.firstChild),C(d.firstChild))}}}},O=function(a){if(a=void 0===a?Z():a){var b=M(a),c=b&&b.nextNode();if(null===c){K(a);var d=H(a);C(d,0)}else{for(;c;)P(c),c=b.nextNode();J(a),H(a)}}else a=I();return a},P=function(a){if(W(a)){var b=a.parentNode;if(T(b)){var c=F();b.insertBefore(c,a),c.appendChild(a),C(a)}}return a},Q=function(){null===M(c).nextNode()?(K(c),I()):O()},R=function(a){return(a=void 0===a?Z():a)&&a.previousSibling},S=function(a){return(a=void 0===a?Z():a)&&a.nextSibling},T=function(a){return a&&"P"==a.tagName},U=function(a){return a&&"A"==a.tagName},V=function(a){return a&&a.isSameNode(c)},W=function(a){return a&&a.nodeType==Node.TEXT_NODE},X=function(a){return a&&"BR"==a.tagName},Y=function(a){var b=a.which||a.keyCode||0;return e(b,"Key"),b},Z=function(a){a=void 0===a?B():a;var b=null;if(a){for(var c=a.endContainer;c&&!V(c)&&!T(c);)c=c.parentNode;if(c)if(T(c))b=c;else{var e="p."+d+":first-child";b=c.querySelector(e)}}return b},$=function(a){a=void 0===a?Z():a;var b=null;if(a)for(b=1;null!==a.previousSibling;)b++,a=a.previousSibling;return b},aa=function(a,b){if(a)if(void 0!==b){if(0===b){var c=a.querySelector("a:first-child");c&&C(c,0)}}else{var d=a.querySelector("a:last-child");d&&C(d)}return a},ba=function(a){return 8==a},ca=function(a){return 13==a},da=function(a){return 32==a||a>47&&a<58||a>64&&a<91||a>95&&a<112||a>185&&a<193||a>218&&a<223},ea=function(){if(!1===p)if($()==A){var a=S();null!==a&&(O(a),aa(a,0))}else{var b=Z();O(R(b)),O(b),aa(b)}},fa=function(a){var b=a.previousSibling;if(b){if(T(b))return b.querySelector("a:nth-last-child(1)");if(U(b))return b}else if(U(a))return fa(a.parentNode)},ga=function(a,b){var c;if(W(a))if((b=void 0===b?a.nodeValue.length:b)>0){var d=a.nodeValue;a.nodeValue=d.slice(0,b-1)+d.slice(b),C(a,b-1),O()}else 0===b?(a=fa(a.parentNode),ga(a.firstChild)):C(a);else X(a)?(c=fa(a.parentNode))&&ga(c.firstChild,-1):(c=fa(a))&&ga(c.firstChild)},ha=function(){var a=B();ga(a.endContainer,a.endOffset)},ia=function(a){var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));var c=B().endContainer;if(W(c))c.nodeValue=c.nodeValue+b,C(c);else{var d=document.createTextNode(b);c.insertBefore(d,c.firstChild),C(d)}ja()},ja=function(a){P(B().endContainer);var b=B(),c=b.endOffset,d=b.endContainer,f=a||d.nodeValue||"",g=q(f);g=g&&g.filter(Boolean)||"";var h=g.length;if(e(g,"splitter"),h>0){var i=d.parentNode;d.nodeValue=g[h-1],r(i,i.firstChild.nodeValue);var j=f.length-g[h-1].length;if(c>j&&c<=f.length&&C(d,c-j),h>1)for(var k=i,l=k.parentNode,m=h-2;m>=0;m--)tagNode=F(g[m]),l.insertBefore(tagNode,k),r(tagNode,tagNode.firstChild.nodeValue),j-=g[m].length,c>j&&c<=j+g[m].length&&C(tagNode.firstChild,c-j),k=tagNode}};return c.addEventListener("keydown",function(a){if(!0===(z=t(a))){A=$();var b=Y(a);ba(b)?(a.preventDefault(),ha()):ca(b)?!0===p&&(a.preventDefault(),s()):da(b)&&N()}}),c.addEventListener("keyup",function(a){if(!0===z){var b=Y(a);da(b)?(O(),ja()):console.log(B().endContainer),ca(b)&&ea(),u()}}),c.addEventListener("paste",function(a){!0===v()&&(a.preventDefault(),ia(a),w())}),c.addEventListener("click",function(a){!0===x()&&(Q(),y())}),this}}(jQuery);
