var Autotag=Autotag||{};Autotag=function(){return function(e,t){function n(e,t){t="undefined"==typeof t?"":t,s&&console.log("TRACE : "+t+" : "+e)}function r(e,t,n){var r;return function(){var o=this,i=arguments,a=function(){r=null,n||e.apply(o,i)},u=n&&!r;clearTimeout(r),r=setTimeout(a,t),u&&e.apply(o,i)}}var o,i,a,u,l,f,d={66:"font-weight:bold",73:"font-style:italic",85:"text-decoration:underline"};t=t||{};var c=t.ignoreReturnKey||!1,s=t.trace||!1,p=t.decorator||function(){},g=t.onReturnKey||function(){},v=t.splitter||function(e){return e.match(/([^\s]+)|\s+/gi)},y=t.afterClick||function(){},h=t.afterKeypress||function(){},m=t.afterPaste||function(){},C=t.beforeClick||function(){return!0},b=t.beforeKeypress||function(){return!0},N=t.beforePaste||function(){return!0},S=function(e){var t=A();return e.appendChild(t),t},E=function(e,t,n){for(var r=0;r<e.length;r++)"autotagCommand"==t?applyCommand(e[r],n):w(e[r],t,n)},w=function(e,t,n){for(var r=0;r<n.length;r++){var o=n[r].split(/\s*:\s*/),i=o[0],a=o[1],u=e.style.getPropertyValue(i);if("autotagUnset"==t||"autotagToggle"==t&&u.length>0)e.style.removeProperty(i);else if("autotagSet"==t||("autotagInitialize"==t||"autotagToggle"==t)&&0===u.length)e.style.setProperty(i,a);else if(t.match(/^autotag(Increment|Decrement)/)){var l=I(a),f=I(u);"autotagIncrement"==t?f+=l:"autotagDecrement"==t&&(f-=l),0>=f?e.style.removeProperty(i):e.style.setProperty(i,f+"px")}}},x=function(){return document.createElement("p")},A=function(){var e=document.createElement("a");return e.appendChild(document.createElement("br")),l&&e.setAttribute("style",l),e},D=function(e){var t=e.getElementsByClassName("autotag-palette")[0];if(t)t.style.display="";else{t=document.createElement("div"),t.className="autotag-palette",e.appendChild(t);for(var n,r=100,i=96;r>=50;r+=-5,i+=-6){n=t.appendChild(document.createElement("div"));for(var a=0;360>a;a+=32)B(n,a,r,i)}for(n=t.appendChild(document.createElement("div")),i=0;100>=i;i+=9)B(n,0,0,i)}o=t},B=function(e,t,n,r){var o=document.createElement("span"),i="hsla("+t+", "+n+"%, "+r+"%, 1.0)";o.className="autotag-color",o.style.color=o.style.background=i,e.appendChild(o)},P=function(){var t=x();return e.appendChild(t),Ae(S(t),0),t},L=function(e){var t=document.createElement("a");return e&&t.appendChild(R(e)),t},R=function(e){return e=e&&e.replace(/ /g,"Â ")||"",document.createTextNode(e)},T=function(){var e=G(),t=e.endContainer;if(t==e.startContainer)if(ee(t))Ae(t,0);else if(de(t))Ae(t.lastChild,0);else if(ie(t)){var n=t.querySelectorAll("a");if(n.length>0){var r=n[e.endOffset-1]||n[n.length-1];Ae(r.lastChild)}}},k=function(t){if(t="undefined"!=typeof t,t||!K())be(e),P();else for(var n=e.childNodes,r=0;r<n.length;r++)"P"!==n[r].tagName&&Ee(n[r])},V=function(e){return e="undefined"==typeof e?F():e,ie(e)&&(0===e.textContent.length?(be(e),Ae(S(e),0)):Se(e)),e},O=function(e,t){if(t="undefined"==typeof t?0:t,e="undefined"==typeof e?G().endContainer:e,ce(e)){var n=e.parentNode;if(ie(n)){var r=L();r.appendChild(e),n.insertBefore(r,e),Ae(e,t)}else de(n)&&Ne(n)}return e},q=function(e){if(u&&e){scope=e.autotagScope||"text";var t;"editor"==scope||("line"==scope?t=U(u):"text"==scope&&(t=Y(u))),t=t.filter(Boolean);for(var n in e)e.hasOwnProperty(n)&&E(t,n,e[n].split(/\s*;\s*/));xe(u)}},I=function(e){return parseInt(e&&e.match(/^[-]*[0-9]+/)[0]||0)},K=function(){return e.querySelector("p:first-child")},z=function(e){return e.which||e.keyCode||0},F=function(e){for(e="undefined"==typeof e?G()&&G().endContainer:e;e&&!re(e)&&!ie(e);)e=e.parentNode;return ie(e)?e:K()},M=function(e){e="undefined"==typeof e?F():e;var t;if(ie(e))for(t=1;e=e.previousSibling;)t++;return t},U=function(e){for(var t=F(e.startContainer),n=F(e.endContainer),r=[t];t&&t!==n;)r.push(t=t.nextSibling);return r},X=function(e){return e="undefined"==typeof e?F():e,ie(e)&&e.nextSibling},_=function(e){var t;return e&&!re(e)&&(ie(e)?t=e.firstChild:(de(e)||le(e))&&(t=e.nextSibling||_(e.parentNode.nextSibling)),t||(t=_(e.parentNode.nextSibling)),ee(t)&&(t=_(t.parentNode.nextSibling))),t},j=function(e){return e="undefined"==typeof e?F():e,ie(e)&&e.previousSibling},G=function(){var e,t;return"undefined"!=typeof window.getSelection?(e=window.getSelection(),e.rangeCount>0&&(t=e.getRangeAt(0))):(e=document.selection)&&"Control"!=e.type&&(t=e.createRange()),t},H=function(e,t){return e&&t&&window.getComputedStyle(e,null).getPropertyValue(t)},J=function(e,t){return t="undefined"==typeof t||0>t?0:t,e.querySelector("a:nth-child("+t+")")},Q=function(e){var t=e.startContainer;return ie(t)&&J(t,e.startOffset+1)||de(t)&&t||ce(t)&&t.parentNode},W=function(e){var t=e.endContainer;return ie(t)&&J(t,e.endOffset)||de(t)&&t||ce(t)&&t.parentNode},Y=function(e){for(var t=Q(e),n=W(e),r=[t];t&&t!==n;)r.push(t=_(t));return r},Z=function(e,t){if(t="undefined"==typeof t?0:t,ie(e))if(0===t){var n=e.querySelector("a:first-child");Ae(n,0)}else{var r=e.querySelectorAll("a");t=r.length>t?t:r.length-1,Ae(r[t])}return e},$=function(e){return e&&"BR"==e.tagName},ee=function(e){return de(e)&&$(e.lastChild)},te=function(e){return e.startContainer==e.endContainer&&e.startOffset==e.endOffset},ne=function(e){return 8==e},re=function(t){return t&&t.isSameNode(e)},oe=function(e){return 66==e||73==e||85==e},ie=function(e){return e&&"P"==e.tagName},ae=function(e){return 32==e||e>47&&58>e||e>64&&91>e||e>95&&112>e||e>185&&193>e||e>218&&223>e},ue=function(e){return 13==e},le=function(e){return e&&"DIV"==e.tagName},fe=function(e){return 9==e},de=function(e){return e&&"A"==e.tagName},ce=function(e){return e&&e.nodeType==Node.TEXT_NODE},se=function(t,n){if(t="undefined"==typeof t?e:t,n="undefined"!=typeof n,n&&we(t.querySelectorAll("div")),ie(t))for(var r=t.querySelectorAll("a"),o=0;o<r.length;o++)Pe(r[o])},pe=function(){o&&(o.style.display="none")},ge=function(){if(o){var e=window.getComputedStyle(o);o.style.display="none"===e.display?"":"none"}},ve=function(e){pe(),e.dataset.autotagPalette?D(e):e.dataset.autotagSelect?(o=e.getElementsByClassName("autotag-submenu")[0],ge()):(q(e.dataset),se(F(),!0))},ye=function(){var e=G(),t=e.endContainer;if(ce(t)){var r=e.endOffset;O(t,r);var o=t.parentNode,i=v(t.nodeValue||"");i=i&&i.filter(Boolean)||"";var a=i.length;if(n(i,"splitter"),a>1){o.style.display="none";for(var u,l,f=0;a>f;f++)u=L(i[f]),u.setAttribute("style",o.getAttribute("style")),u.style.display="inline",p(u,u.firstChild.nodeValue),o.parentNode.insertBefore(u,o.nextSibling),l=i[f].length,r>0&&l>=r&&Ae(u.firstChild,r),r-=l,o=u;Ee(t.parentNode)}else p(o,o.firstChild.nodeValue)}else de(t)&&ce(t.firstChild)&&p(t,t.firstChild.nodeValue)},he=function(e){var t;e.clipboardData?t=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(t=window.clipboardData.getData("Text"));var n=G().endContainer;if(re(n)&&(k(!0),n=G().endContainer),ce(n))n.nodeValue=n.nodeValue+t,Ae(n);else{var r=document.createTextNode(t);n.insertBefore(r,n.firstChild),Ae(r)}ye()},me=function(){if(c===!1){var e=F();if(M(e)==i){var t=X(e);null!==t&&(V(t),Z(t,0))}else{var n=j(e);V(n),V(e),Z(e,0)}k(),ye(),T()}},Ce=function(){var e=G(),t=e.endContainer.parentNode;te(e)&&de(t)&&(Le(t,e.endOffset),se(F(),!0))},be=function(e){for(;e&&e.hasChildNodes();)e.removeChild(e.lastChild);return e},Ne=function(e){return we(e&&e.querySelectorAll("br"))},Se=function(e){return e="undefined"==typeof e?F():e,ie(e)&&Ne(e)},Ee=function(e){return e&&e.parentNode&&e.parentNode.removeChild(e)},we=function(e){for(var t=0;e&&t<=e.length;t++)Ee(e[t]);return e},xe=function(e){if(e)if(window.getSelection){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges(),t.addRange(e)}else document.createRange?window.getSelection().addRange(e):document.selection&&e.select();return e},Ae=function(e,t){return t="undefined"==typeof t?e.length:t,Be(e,t,e,t)},De=function(){var e=G().endContainer,t=de(e)&&e||ce(e)&&e.parentNode;l=t&&t.getAttribute("style")||l},Be=function(e,t,n,r){var o;if(e&&n){t="undefined"==typeof t?0:t,r="undefined"==typeof r?n.length:r,o=document.createRange();try{o.setStart(e,t),o.setEnd(n,r),u=o}catch(i){}xe(o)}return o},Pe=function(e){if(e){var t=parseFloat(H(e,"font-size"));if(e.getBoundingClientRect().height>1.3*t){var n=e.previousSibling&&"DIV"===e.previousSibling.tagName;n||e.parentNode.insertBefore(document.createElement("div"),e)}}return e},Le=function(e,t){var n=e.textContent,r=e.parentNode,o=e.nextSibling,i=L("    ");if(0===t)r.insertBefore(i,e),Ae(e.firstChild,0);else if(t===e.firstChild.length)o&&(r.insertBefore(i,o),Ae(o.firstChild,0));else{e.textContent=n.substring(0,t),r.insertBefore(i,o);var a=L(n.substring(t));r.insertBefore(a,i.nextSibling),Ae(a.firstChild,0)}};return document.addEventListener("selectionchange",r(function(){u=G()},250)),e.addEventListener("dblclick",function(){u=G()}),e.addEventListener("click",function(){pe(),u=G(),C()&&(k(),y())}),e.addEventListener("focus",function(){u=G(),k()}),e.addEventListener("keydown",function(e){if(a=b(e),a===!0){i=M();var t=z(e);ne(t)?T():ue(t)?c?(e.preventDefault(),g()):De():fe(t)?(Ce(t),e.preventDefault()):e.metaKey&&oe(t)&&(e.preventDefault(),q({autotagToggle:d[t]}))}}),e.addEventListener("keyup",function(e){if(a===!0){var t=z(e);ne(t)?(re(G().endContainer)?k():V(),se(F(),!0)):ue(t)?me():ae(t)&&(V(),ye(),se(F(),!0)),h()}}),e.addEventListener("paste",function(e){N()===!0&&(e.preventDefault(),he(e),m())}),window.addEventListener("resize",r(function(){se(F(),!0)},250)),k(),{attachMenubar:function(e){e&&(f=e,f.addEventListener("click",function(e){if(u){xe(u);var t=e.target;if(t.classList.contains("autotag-menu")||t.parentNode.classList.contains("autotag-submenu"))ve(t);else if(t.classList.contains("autotag-color")){var n,r=t.style.backgroundColor,i=o.parentNode.dataset;"color"==i.autotagPalette?n="color: "+r:"fill"==i.autotagPalette&&(n="background-color: "+r),i.autotagSet=n,q(i),pe()}}else pe()}))}}}}();
