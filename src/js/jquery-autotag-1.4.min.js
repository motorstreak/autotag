!function(a){a.fn.autotag=function(b){function e(a){return a.split(/(\B[^,;\.\w]\b\w+(?=\W*))/gi)}function f(a){var b=a.firstChild.nodeValue;return b.match(/^#[\w]+/)?a.className="autotag-hashtag":b.match(/^@[\w]+/)?a.className="autotag-attag":a.removeAttribute("class"),a}var c=a(this)[0],d="autotag-line";b=b||{};var j,g=b.trace||!1,h=b.splitter||e,i=b.decorator||f,k=function(){var a;return window.getSelection?a=window.getSelection().getRangeAt(0):document.selection&&(a=document.selection.createRange()),a},l=function(a,b){var c;if(null!==a){b=void 0===b?a.length:b,c=k();try{c.setStart(a,b),c.setEnd(a,b)}catch(a){}m(c)}return activeRange=k(),c},m=function(a){if(null!==a)if(window.getSelection){var b=window.getSelection();b.rangeCount>0&&b.removeAllRanges(),b.addRange(a)}else document.createRange?window.getSelection().addRange(a):document.selection&&a.select();return k()},n=function(a){return a=a&&a.replace(/ /g,"\u00a0")||"",document.createTextNode(a)},o=function(){var a=document.createElement("a"),b=document.createElement("br");return a.appendChild(b),a},p=function(a){var b=document.createElement("a");if(a){var c=n(a);b.appendChild(c)}return b},q=function(a){var b=document.createElement("p");return b.className=d,null!==a&&b.appendChild(a),b},r=function(){var a=o();return q(a)},s=function(a){for(;a&&a.hasChildNodes();)a.removeChild(a.lastChild);return a},u=function(a){return a&&document.createTreeWalker(a,NodeFilter.SHOW_TEXT,null,!1)},v=function(a){if(a=void 0===a?C():a){var b=u(a),d=b&&b.nextNode();if(null===d){s(a);var e=o();a.appendChild(e),l(e,0)}else{for(;d;)w(d).parentNode,d=b.nextNode();var g=a.querySelector("br:last-child");if(g){g.previousSibling.appendChild(g)}}}else a=r(),c.appendChild(a);return a},w=function(a){var b=a.parentNode;if(a.nodeType==Node.TEXT_NODE&&A(b)){var c=p();b.insertBefore(c,a),c.appendChild(a),l(a)}return a},x=function(){if(null===u(c).nextNode()){s(c);var d=o(),e=q(d);c.appendChild(e),l(d,0)}else v()},y=function(a){return(a=void 0===a?C():a)&&a.previousSibling},z=function(a){return(a=void 0===a?C():a)&&a.nextSibling},A=function(a){return a&&"P"==a.tagName&&a.className===d},B=function(a){return a&&a.isSameNode(c)},C=function(a){a=void 0===a?k():a;var b=null;if(a){for(var c=a.endContainer;!B(c)&&!A(c)&&(c=c.parentElement););if(A(c))b=c;else{var e="p."+d+":first-child";b=c.querySelector(e)}}return b},D=function(a){a=void 0===a?C():a;var b=null;if(a)for(b=1;null!==a.previousSibling;)b++,a=a.previousSibling;return b},F=function(a,b){if(a)if(void 0!==b){if(0===b){var c=a.querySelector("a:first-child");c&&l(c,0)}}else{var d=a.querySelector("a:last-child");d&&l(d)}return a},G=function(a){v(),w(k().endContainer);var b=k(),c=b.endOffset,d=b.endContainer,e=a||d.nodeValue||"",f=h(e);f=f&&f.filter(Boolean)||"";var j=f.length;if(g&&console.log(f),j>0){var m=d.parentNode;d.nodeValue=f[j-1],i(m);var n=e.length-f[j-1].length;if(c>n&&c<=e.length&&l(d,c-n),j>1)for(var o=m,q=o.parentNode,r=j-2;r>=0;r--)tagNode=p(f[r]),q.insertBefore(tagNode,o),i(tagNode),n-=f[r].length,c>n&&c<=n+f[r].length&&l(tagNode.firstChild,c-n),o=tagNode}};return c.addEventListener("keydown",function(a){j=D()}),c.addEventListener("keyup",function(a){if(G(),13==(a.keyCode?a.keyCode:a.which))if(D()==j){var c=z();null!==c&&(v(c),F(c,0))}else{var d=C();v(y(d)),v(d),F(d)}}),c.addEventListener("paste",function(a){a.preventDefault();var b;a.clipboardData?b=(a.originalEvent||a).clipboardData.getData("text/plain"):window.clipboardData&&(b=window.clipboardData.getData("Text"));var c=k().endContainer;if(c.nodeValue)c.nodeValue.concat(b);else{var d=document.createTextNode(b);c.insertBefore(d,c.firstChild),l(d,0)}G()}),c.addEventListener("click",function(a){x()}),c.addEventListener("focus",function(a){x()}),this}}(jQuery);
