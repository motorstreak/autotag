var Autotag=Autotag||{};Autotag=function(){return function(e,t){function n(e,t){t=void 0===t?"":t,s&&console.log("TRACE : "+t+" : "+e)}function r(e,t,n){var r;return function(){var o=this,i=arguments,a=function(){r=null,n||e.apply(o,i)},u=n&&!r;clearTimeout(r),r=setTimeout(a,t),u&&e.apply(o,i)}}var o,i,a,u,l,c,d={66:"font-weight:bold",73:"font-style:italic",85:"text-decoration:underline"},f=(t=t||{}).ignoreReturnKey||!1,s=t.trace||!1,g=t.decorator||function(e,t){},v=t.onReturnKey||function(){},p=t.splitter||function(e){return e.match(/([^\s]+)|\s+/gi)},h=t.afterClick||function(){},m=t.afterKeypress||function(){},C=t.afterPaste||function(){},y=t.afterSelection||function(e){},b=t.beforeClick||function(){return!0},N=t.beforeKeypress||function(){return!0},S=t.beforePaste||function(){return!0},E=function(e){return e.appendChild(B())},w=function(e,t){for(var n=0;n<t.length;n++)"clear"==t[n]&&e.setAttribute("style","")},x=function(e,t,n){for(var r=0;r<e.length;r++)"autotagCommand"==t?w(e[r],n):A(e[r],t,n)},A=function(e,t,n){for(var r=0;r<n.length;r++){var o=n[r].split(/\s*:\s*/),i=o[0],a=o[1],u=e.style.getPropertyValue(i);if("autotagUnset"==t||"autotagToggle"==t&&u.length>0)e.style.removeProperty(i);else if("autotagSet"==t||("autotagInitialize"==t||"autotagToggle"==t)&&0===u.length)e.style.setProperty(i,a);else if(t.match(/^autotag(Increment|Decrement)/)){var l=z(a),c=z(u);"autotagIncrement"==t?c+=l:"autotagDecrement"==t&&(c-=l),c<=0?e.style.removeProperty(i):e.style.setProperty(i,c+"px")}}},D=function(){return document.createElement("p")},B=function(){var e=document.createElement("autotag");return e.appendChild(document.createElement("br")),l&&e.setAttribute("style",l),e},L=function(e){var t=e.getElementsByClassName("autotagjs-submenu")[0];if(t)t.style.display="";else{(t=document.createElement("div")).className="autotagjs-submenu",e.appendChild(t);for(var n,r=100,i=96;r>=50;r+=-5,i+=-6){n=t.appendChild(document.createElement("div"));for(var a=0;a<360;a+=32)P(n,a,r,i)}for(n=t.appendChild(document.createElement("div")),i=0;i<=100;i+=9)P(n,0,0,i)}o=t},P=function(e,t,n,r){var o=document.createElement("span"),i="hsla("+t+", "+n+"%, "+r+"%, 1.0)";o.className="autotag-color",o.style.color=o.style.background=i,e.appendChild(o)},R=function(){var t=D();return e.appendChild(t),De(E(t),0),t},T=function(e){var t=document.createElement("autotag");return e&&t.appendChild(k(e)),t},k=function(e){return e=e&&e.replace(/ /g,"\u00a0")||"",document.createTextNode(e)},V=function(){var e=J(),t=e.endContainer;if(t==e.startContainer)if(ne(t))De(t,0);else if(fe(t))De(t.lastChild,0);else if(ue(t)){var n=t.querySelectorAll("autotag");if(n.length>0){var r=n[e.endOffset-1]||n[n.length-1];De(r.lastChild)}}},O=function(t){if((t=void 0!==t)||!U())Ne(e),R();else for(var n=e.childNodes,r=0;r<n.length;r++)"P"!==n[r].tagName&&we(n[r])},q=function(e){return e=void 0===e?M():e,ue(e)&&(0===e.textContent.length?(Ne(e),De(E(e),0)):Ee(e)),e},I=function(e,t){if(t=void 0===t?0:t,e=void 0===e?J().endContainer:e,se(e)){var n=e.parentNode;if(ue(n)){var r=T();n.insertBefore(r,e),r.appendChild(e),De(e,t)}else fe(n)&&Se(n)}return e},K=function(e){if(u&&e){scope=e.autotagScope||"text";var t;"editor"==scope||("line"==scope?t=_(u):"text"==scope&&(t=$(u))),t=t.filter(Boolean);for(var n in e)e.hasOwnProperty(n)&&x(t,n,e[n].split(/\s*;\s*/));Ae(u)}},z=function(e){return parseInt(e&&e.match(/^[-]*[0-9]+/)[0]||0)},U=function(){return e.querySelector("p:first-child")},F=function(e){return e.which||e.keyCode||0},M=function(e){for(e=void 0===e?J()&&J().endContainer:e;e&&!ie(e)&&!ue(e);)e=e.parentNode;return ue(e)?e:U()},X=function(e){e=void 0===e?M():e;var t;if(ue(e))for(t=1;e=e.previousSibling;)t++;return t},_=function(e){for(var t=M(e.startContainer),n=M(e.endContainer),r=[t];t&&t!==n;)r.push(t=t.nextSibling);return r},j=function(e){return e=void 0===e?M():e,ue(e)&&e.nextSibling},G=function(e){var t;return e&&!ie(e)&&(ue(e)?t=e.firstChild:(fe(e)||ce(e))&&(t=e.nextSibling||G(e.parentNode.nextSibling)),t||(t=G(e.parentNode.nextSibling)),ne(t)&&(t=G(t.parentNode.nextSibling))),t},H=function(e){return e=void 0===e?M():e,ue(e)&&e.previousSibling},J=function(){var e,t;return void 0!==window.getSelection?(e=window.getSelection()).rangeCount>0&&(t=e.getRangeAt(0)):(e=document.selection)&&"Control"!=e.type&&(t=e.createRange()),t},Q=function(e,t){return e&&t&&window.getComputedStyle(e,null).getPropertyValue(t)},W=function(e,t){return t=void 0===t||t<0?0:t,e.querySelector("a:nth-child("+t+")")},Y=function(e){var t=e.startContainer;return ue(t)&&W(t,e.startOffset+1)||fe(t)&&t||se(t)&&t.parentNode},Z=function(e){var t=e.endContainer;return ue(t)&&W(t,e.endOffset)||fe(t)&&t||se(t)&&t.parentNode},$=function(e){for(var t=Y(e),n=Z(e),r=t&&[t]||[];t&&t!==n;)r.push(t=G(t));return r},ee=function(e,t){if(t=void 0===t?0:t,ue(e))if(0===t){var n=e.querySelector("a:first-child");De(n,0)}else{var r=e.querySelectorAll("autotag");t=r.length>t?t:r.length-1,De(r[t])}return e},te=function(e){return e&&"BR"==e.tagName},ne=function(e){return fe(e)&&te(e.lastChild)},re=function(e){return e.startContainer==e.endContainer&&e.startOffset==e.endOffset},oe=function(e){return 8==e},ie=function(t){return t&&t.isSameNode(e)},ae=function(e){return 66==e||73==e||85==e},ue=function(e){return e&&"P"==e.tagName},le=function(e){return 13==e},ce=function(e){return e&&"DIV"==e.tagName},de=function(e){return 9==e},fe=function(e){return e&&e.tagName=="autotag".toUpperCase()},se=function(e){return e&&e.nodeType==Node.TEXT_NODE},ge=function(t,n){if(t=void 0===t?e:t,(n=void 0!==n)&&xe(t.querySelectorAll("div")),ue(t))for(var r=t.querySelectorAll("autotag"),o=0;o<r.length;o++)Pe(r[o])},ve=function(){o&&(o.style.display="none")},pe=function(){if(o){var e=window.getComputedStyle(o);o.style.display="none"===e.display?"":"none"}},he=function(e){ve(),e.dataset.autotagPalette?L(e):e.dataset.autotagSelect?(o=e.getElementsByClassName("autotag-submenu")[0],pe()):(K(e.dataset),ge(M(),!0))},me=function(){var e=J(),t=e.endContainer;if(se(t)){var r=e.endOffset;I(t,r);var o=t.parentNode,i=p(t.nodeValue||""),a=(i=i&&i.filter(Boolean)||"").length;if(n(i,"splitter"),a>1){o.style.display="none";for(var u,l,c=0;c<a;c++)(u=T(i[c])).setAttribute("style",o.getAttribute("style")),u.style.display="inline",g(u,u.firstChild.nodeValue),o.parentNode.insertBefore(u,o.nextSibling),l=i[c].length,r>0&&r<=l&&De(u.firstChild,r),r-=l,o=u;we(t.parentNode)}else g(o,o.firstChild.nodeValue)}else fe(t)&&se(t.firstChild)&&g(t,t.firstChild.nodeValue)},Ce=function(e){var t;e.clipboardData?t=(e.originalEvent||e).clipboardData.getData("text/plain"):window.clipboardData&&(t=window.clipboardData.getData("Text"));var n=J().endContainer;if(ie(n)&&(O(!0),n=J().endContainer),se(n))n.nodeValue=n.nodeValue+t,De(n);else{var r=document.createTextNode(t);n.insertBefore(r,n.firstChild),De(r)}me()},ye=function(){if(!1===f){var e=M();if(X(e)==i){var t=j(e);null!==t&&(q(t),ee(t,0))}else{var n=H(e);q(n),q(e),ee(e,0)}O(),me(),V()}},be=function(e){var t=J(),n=t.endContainer.parentNode;re(t)&&fe(n)&&(Re(n,t.endOffset),ge(M(),!0))},Ne=function(e){for(;e&&e.hasChildNodes();)e.removeChild(e.lastChild);return e},Se=function(e){return xe(e&&e.querySelectorAll("br"))},Ee=function(e){return e=void 0===e?M():e,ue(e)&&Se(e)},we=function(e){return e&&e.parentNode&&e.parentNode.removeChild(e)},xe=function(e){for(var t=0;e&&t<=e.length;t++)we(e[t]);return e},Ae=function(e){if(e)if(window.getSelection){var t=window.getSelection();t.rangeCount>0&&t.removeAllRanges(),t.addRange(e)}else document.createRange?window.getSelection().addRange(e):document.selection&&e.select();return e},De=function(e,t){return t=void 0===t?e.length:t,Le(e,t,e,t)},Be=function(){var e=J().endContainer,t=fe(e)&&e||se(e)&&e.parentNode;l=t&&t.getAttribute("style")||l},Le=function(e,t,n,r){var o;if(e&&n){t=void 0===t?0:t,r=void 0===r?n.length:r,o=document.createRange();try{o.setStart(e,t),o.setEnd(n,r),u=o}catch(e){}Ae(o)}return o},Pe=function(e){if(e){var t=parseFloat(Q(e,"font-size"));e.getBoundingClientRect().height>1.3*t&&(e.previousSibling&&"DIV"===e.previousSibling.tagName||e.parentNode.insertBefore(document.createElement("div"),e))}return e},Re=function(e,t){var n=e.textContent,r=e.parentNode,o=e.nextSibling,i=T("    ");if(0===t)r.insertBefore(i,e),De(e.firstChild,0);else if(t===e.firstChild.length)o&&(r.insertBefore(i,o),De(o.firstChild,0));else{e.textContent=n.substring(0,t),r.insertBefore(i,o);var a=T(n.substring(t));r.insertBefore(a,i.nextSibling),De(a.firstChild,0)}};return document.addEventListener("selectionchange",r(function(e){u=J(),y($(u))},500)),e.addEventListener("dblclick",function(e){u=J()}),e.addEventListener("click",function(e){ve(),u=J(),b()&&(O(),h())}),e.addEventListener("focus",function(e){u=J(),O()}),e.addEventListener("textInput",function(e){!0===a&&(q(),me(),ge(M(),!0))}),e.addEventListener("keydown",function(e){if(!0===(a=N(e))){i=X();var t=F(e);oe(t)?V():le(t)?f?(e.preventDefault(),v()):Be():de(t)?(be(),e.preventDefault()):e.metaKey&&ae(t)&&(e.preventDefault(),K({autotagToggle:d[t]}))}}),e.addEventListener("keyup",function(e){if(!0===a){var t=F(e);oe(t)?(ie(J().endContainer)?O():q(),ge(M(),!0)):le(t)&&ye(),m()}}),e.addEventListener("paste",function(e){!0===S()&&(e.preventDefault(),Ce(e),C())}),window.addEventListener("resize",r(function(e){ge(M(),!0)},250)),O(),{attachMenubar:function(e){e&&(c=e).addEventListener("click",function(e){Ae(u);var t=e.target;if(t.classList.contains("autotagjs-menu")||t.parentNode.classList.contains("autotag-submenu"))he(t);else if(t.parentNode.classList.contains("autotagjs-menu"))he(t.parentNode);else if(t.classList.contains("autotag-color")){var n,r=t.style.backgroundColor,i=o.parentNode.dataset;"color"==i.autotagPalette?n="color: "+r:"fill"==i.autotagPalette&&(n="background-color: "+r),i.autotagSet=n,K(i),ve()}})}}}}();
